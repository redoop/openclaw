<?xml version="1.0" encoding="UTF-8"?>
<Wix xmlns="http://schemas.microsoft.com/wix/2006/wi"
     xmlns:util="http://schemas.microsoft.com/wix/UtilExtension">
  
  <?define ProductVersion="2026.2.14" ?>
  <?define ProductName="OpenClaw" ?>
  <?define Manufacturer="OpenClaw Project" ?>
  
  <Product Id="*" 
           Name="$(var.ProductName)" 
           Version="$(var.ProductVersion)"
           Manufacturer="$(var.Manufacturer)" 
           UpgradeCode="A1B2C3D4-E5F6-4A5B-8C9D-0E1F2A3B4C5D"
           Language="1033">
    
    <Package InstallerVersion="500" 
             Compressed="yes" 
             InstallScope="perMachine"
             Description="OpenClaw - Personal AI Assistant"
             Comments="https://openclaw.ai" />

    <!-- 升级策略 -->
    <MajorUpgrade DowngradeErrorMessage="A newer version is already installed." />
    
    <MediaTemplate EmbedCab="yes" />

    <!-- 系统要求 -->
    <Condition Message="Windows 10 or later required.">
      <![CDATA[Installed OR (VersionNT >= 603)]]>
    </Condition>

    <!-- 功能组件 -->
    <Feature Id="ProductFeature" 
             Title="OpenClaw CLI" 
             Level="1"
             ConfigurableDirectory="INSTALLFOLDER">
      <ComponentGroupRef Id="NodeJSComponents" />
      <ComponentGroupRef Id="OpenClawComponents" />
      <ComponentRef Id="EnvironmentPath" />
      <ComponentRef Id="ConfigDirectory" />
      <ComponentRef Id="GatewayService" />
    </Feature>

    <!-- 安装目录 -->
    <Directory Id="TARGETDIR" Name="SourceDir">
      <Directory Id="ProgramFiles64Folder">
        <Directory Id="INSTALLFOLDER" Name="OpenClaw">
          <Directory Id="NodeJSFolder" Name="nodejs" />
          <Directory Id="CLIFolder" Name="cli" />
        </Directory>
      </Directory>
      
      <Directory Id="ProgramMenuFolder">
        <Directory Id="ApplicationProgramsFolder" Name="OpenClaw" />
      </Directory>
    </Directory>

    <!-- 环境变量 -->
    <Component Id="EnvironmentPath" 
               Directory="INSTALLFOLDER" 
               Guid="B2C3D4E5-F6A7-4B5C-9D0E-1F2A3B4C5D6E">
      <Environment Id="PATH" 
                   Name="PATH" 
                   Value="[INSTALLFOLDER]cli;[INSTALLFOLDER]nodejs" 
                   Permanent="no" 
                   Part="last" 
                   Action="set" 
                   System="yes" />
    </Component>

    <!-- 配置目录 -->
    <Component Id="ConfigDirectory" 
               Directory="INSTALLFOLDER" 
               Guid="C3D4E5F6-A7B8-4C5D-0E1F-2A3B4C5D6E7F">
      <CreateFolder Directory="INSTALLFOLDER" />
      <util:PermissionEx User="Users" 
                         GenericAll="yes" 
                         Domain="[LOCAL_MACHINE_NAME]" />
    </Component>

    <!-- Windows 服务 -->
    <Component Id="GatewayService" 
               Directory="CLIFolder" 
               Guid="D4E5F6A7-B8C9-4D5E-1F2A-3B4C5D6E7F8A">
      <File Id="ServiceWrapper" 
            Source="$(var.SourceDir)\service\openclaw-service.exe" 
            KeyPath="yes" />
      
      <ServiceInstall Id="OpenClawGatewayService"
                      Type="ownProcess"
                      Name="OpenClawGateway"
                      DisplayName="OpenClaw Gateway"
                      Description="OpenClaw AI Assistant Gateway Service"
                      Start="auto"
                      Account="LocalSystem"
                      ErrorControl="normal"
                      Arguments='--config "[CommonAppDataFolder]openclaw\openclaw.json"'>
        <util:ServiceConfig FirstFailureActionType="restart"
                           SecondFailureActionType="restart"
                           ThirdFailureActionType="restart"
                           RestartServiceDelayInSeconds="60" />
      </ServiceInstall>
      
      <ServiceControl Id="StartService"
                      Start="install"
                      Stop="both"
                      Remove="uninstall"
                      Name="OpenClawGateway"
                      Wait="yes" />
    </Component>

    <!-- 开始菜单快捷方式 -->
    <DirectoryRef Id="ApplicationProgramsFolder">
      <Component Id="ApplicationShortcut" 
                 Guid="E5F6A7B8-C9D0-4E5F-2A3B-4C5D6E7F8A9B">
        <Shortcut Id="CmdShortcut"
                  Name="OpenClaw CLI"
                  Description="OpenClaw Command Line"
                  Target="[System64Folder]cmd.exe"
                  Arguments='/k "cd /d [INSTALLFOLDER]cli &amp;&amp; [NodeJSFolder]node.exe openclaw.js --help"'
                  WorkingDirectory="CLIFolder" />
        <RemoveFolder Id="CleanUpShortCut" 
                      Directory="ApplicationProgramsFolder" 
                      On="uninstall" />
        <RegistryValue Root="HKCU" 
                       Key="Software\OpenClaw" 
                       Name="installed" 
                       Type="integer" 
                       Value="1" 
                       KeyPath="yes" />
      </Component>
    </DirectoryRef>

    <Property Id="ARPPRODUCTICON" Value="DefaultIcon" />
    <Icon Id="DefaultIcon" SourceFile="$(var.SystemFolder)cmd.exe" />
    
    <!-- UI 引用 -->
    <UIRef Id="CustomUI" />
  </Product>
</Wix>
